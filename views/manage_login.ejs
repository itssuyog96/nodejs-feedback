<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->

<% include tpl/header.ejs %>

<style>
    .modal-backdrop{
        z-index: 10048 !important;
    }
</style>

<body class="page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid">
<!-- BEGIN HEADER -->

<% include tpl/menu.ejs %>

<!-- END HEADER -->


<!-- BEGIN HEADER & CONTENT DIVIDER -->
<div class="clearfix"></div>
<!-- END HEADER & CONTENT DIVIDER -->

<!-- BEGIN CONTAINER -->
<div class="page-container">
    <% include tpl/sidebar.ejs %>
    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">
            <!-- BEGIN PAGE HEADER-->

            <!--h3 class="page-title"> Blank Page Layout
                <small>blank page layout</small>        To be resolved
            </h3-->

            <!-- END PAGE HEADER-->


            <!--START EDITING FROM HERE-->

            <div class="portlet light">
                <div class="portlet-title">
                    <div class="caption font-dark">
                        <i class="icon-settings font-dark"></i>
                        <span class="caption-subject bold uppercase">User Table</span>
                    </div>
                </div>
                <div class="portlet-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="user-table"
                                   class="table table-striped table-bordered table-hover table-checkable order-column">
                                <thead>
                                <tr>
                                    <th>Sr.No.</th>
                                    <th>Role</th>
                                    <th>College Id</th>
                                    <th>Department Id</th>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Mobile</th>
                                    <th>Email Id</th>
                                    <th>Generate &amp; Send Link</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-2 col-sm-2 col-xs-12">
                            <a id="col_modal_btn" class="btn green btn-outline" data-toggle="modal"
                               data-target="#add_user_modal">ADD USER</a>
                        </div>
                    </div>
                </div>
            </div>


            <!--STOP EDITING HERE-->

        </div>
        <!-- END CONTENT BODY -->
    </div>
    <!-- END CONTENT -->
    <% include tpl/quicksidebar.ejs %>
</div>

<!-- END CONTAINER -->

<!-- Add user modal -->
<div class="modal fade div_user_add" id="add_user_modal" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">Add New User</h4>
            </div>
            <div class="modal-body">
                <form id="form-user_add">
                    <input type="hidden" name="reg" value="1" />
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-4">
                            <label for="role" class="form-control" required>Select Role</label>
                        </div>
                        <div class="form-group col-md-7">
                            <select id="role" name="role" class="form-control">
                                <option value="principal">Principal</option>
                                <option value="hod" selected>Head of Department</option>
                                <option value="feed_analyzer">Feedback Analyzer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-12 col_id_div">
                        <div class="form-group col-md-4">
                            <label for="col_id" class="form-control" required>College ID</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="text" name="col_id" class="form-control " required/>
                        </div>
                    </div>
                    <div class="form-group col-md-12 dept_id_div">
                        <div class="form-group col-md-4">
                            <label for="dep_id" class="form-control">Department ID</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="text" name="dep_id" class="form-control " required/>
                        </div>
                    </div>
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-4">
                            <label for="name" class="form-control" required>Name</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="text" name="name" class="form-control " required/>
                        </div>
                    </div>
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-4">
                            <label for="username" class="form-control" required>Username</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="text" name="username" class="form-control " required/>
                        </div>
                    </div>
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-4">
                            <label for="contact" class="form-control">Contact</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="text" name="contact" class="form-control " required/>
                        </div>
                    </div>
                    <div class="form-group col-md-12">
                        <div class="form-group col-md-4">
                            <label for="email_id" class="form-control">E-mail ID</label>
                        </div>
                        <div class="form-group col-md-7">
                            <input type="email" name="email_id" class="form-control " required/>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn dark btn-outline close-user_add" data-dismiss="modal">Close</button>
                <button type="button" class="btn green user_add">Save changes</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->


<!-- END MODALS -->

<% include tpl/footer.ejs %>

<script src="../javascripts/global/scripts/datatable.js" type="text/javascript"></script>
<script src="../javascripts/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
<script src="../javascripts/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
<script src="../javascripts/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
<script src="../javascripts/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>

<script>

    var load_users = function(){
        $.ajax({
            url: '../../ajax/load_users',
            data: {col_id: 1},
            method: 'POST',
            success: function(data){
              console.log(data);
              var i = 0;
                $('#user-table tbody').text('');
              data.forEach(function(item){

                  $('#user-table tbody').append('<tr>' +
                      '<td>'+(i++)+'</td>' +
                      '<td>'+item.role+'</td>' +
                      '<td>'+item.col_id+'</td>' +
                      '<td>'+item.dep_id+'</td>' +
                      '<td>'+item.nickname+'</td>' +
                      '<td>'+item.name+'</td>' +
                      '<td>'+item.contact+'</td>' +
                      '<td>'+item.email_id+'</td>' +
                      '<td><button class="btn btn-default" onclick="javascript:generate_url(\''+item.password+'\',\''+item.nickname+'\',\''+item.contact+'\',\''+item.email_id+'\',\''+item._id+'\')">GENERATE & SEND URL</button></td>' +
                      '<td><button id="btn-'+item._id+'" class="btn red btn-outline" onclick="javascript:delete_user(\''+item._id+'\')">DELETE</button><img style="display:none;" height="4.5%" width="20%" src="https://i.stack.imgur.com/kOnzy.gif" id="loader-'+item._id+'"></img></td>' +
                      '</tr>');
              });
            },
            error: function(error){
                console.log(error.responseText);
            }
        });
    };

    load_users();

</script>

<script>

    generate_url = function(key, nickname, contact, email_id,id){
        console.log("Sending URL to : " + nickname + "...");
        $.ajax({
            url: '../../generateurl',
            data: {key: key, nickname: nickname, contact: contact, email_id: email_id,id:id},
//            data: {nameH: contact, key: username, username: username, contact: contact, email_id: email_id},
            method: 'GET',
            success: function(){
                console.log('Successfully generated & sent!');
            },
            error: function(error){
                console.log('Error : '+error.responseText);
            }
        });
    }

    function delete_user(id){
        $('#btn-'+id).fadeOut(0);
        $('#loader-'+id).fadeIn();

        $.ajax({
            url: '../../ajax/deleteuser',
            method: 'POST',
            data: {_id: id},
            success: function(){
                load_users();
            },
            error: function(){
                console.log('Error occured while deleting user!');
                $('#loader-'+id).fadeOut();
                $('#btn-'+id).fadeIn();
            }
        })
    }
</script>

<script>

    $('.modal-footer').on('click', '.user_add', function(e){
        e.preventDefault();
        console.log(JSON.stringify($('#form-user_add').serialize()));
        var data = $('#form-user_add').serialize();
        console.log(data);
        console.log('inside');
        $.ajax({
            url: '../ajax/adminReg',
            data: data,
            method: 'POST',
            success: function(data){
                load_users();
            },
            error: function(data){
                console.log("Error occured while adding user! "+data.responseText);
            }
        });
    });

</script>

<script>
    $('#role').change(function(){
        switch($('#role').val()){
            case 'principal':
                $('.col_id_div').fadeIn();
                $('.dept_id_div').fadeOut();
                break;
            case 'hod':
            case 'faculty':
            case 'feed_analyzer':
                $('.col_id_div').fadeIn();
                $('.dept_id_div').fadeIn();
                break;
            case 'admin':
                $('.col_id_div').fadeOut();
                $('.dept_id_div').fadeOut();
        }
    });
</script>

</body>

</html>